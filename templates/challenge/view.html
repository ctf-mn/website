%extends 'Layout.html'
%set title = challenge.title

%block content
  <div class="max-w-3xl w-full mx-auto border dark:border-slate-700 shadow bg-white dark:bg-slate-800 mt-4 p-4 rounded">
    <div class="text-xl font-medium border-b dark:border-slate-700 pb-2 mb-2">
      {{ challenge.title }}
    </div>
    <div class="text-slate-500 dark:text-slate-300 mb-4 flex justify-between">
      <div>
        <a href="/challenge/list?category={{ challenge.category }}&event=all" class="x-link">
          {{- g.category_dict[challenge.category] -}}
        </a>
        &middot;
        <a href="/challenge/list?category=all&event={{ challenge.event }}" class="x-link">
          {{- g.event_dict[challenge.event] -}}
        </a>
        &middot;
        <a href="/author/{{ challenge.author }}" class="x-link">
          {{ challenge.author }}
        </a>
      </div>
      <div>
        Solved: {{ challenge.solved_count }}
        &middot;
        Score: {{ challenge.score }}
      </div>
    </div>

    <div data-page-content class="prose max-w-none">
      {{ challenge.content }}
    </div>

    %if not g.user
      <div class="border-t dark:border-slate-700 pt-4 mt-4">
        <div class="mb-4 bg-yellow-100 dark:bg-yellow-900/25 border dark:border-slate-700 border-yellow-200 text-sm text-yellow-800 dark:text-yellow-200 rounded-lg p-4" role="alert">
          <span class="font-bold">Login required</span> to submit flag.
        </div>
      </div>
      <div class="flex gap-4 items-center">
        <div class="grow">
          <input type="text" name="flag" class="border dark:border-slate-700 text-sm rounded-lg block w-full py-2 px-3 bg-gray-200 dark:bg-slate-700 border-gray-300 dark:border-slate-600 text-gray-900 dark:text-slate-100 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400" name="" value="" placeholder="Flag" disabled>
        </div>
        <button type="submit" name="action" value="flag" class="text-white dark:text-white bg-blue-700 hover:bg-blue-800 dark:hover:bg-blue-500 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-400 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
          Submit flag
        </button>
      </div>
    %elif solved
      <div class="flex gap-4 items-center border-t dark:border-slate-700 pt-4 mt-4">
        <div class="text-green-600 dark:text-green-300">
          Congratulations! You already solved this challenge.
        </div>
      </div>
    %else
      <Form>
        <div class="border-t dark:border-slate-700 pt-4 mt-4">
          %if status == 'incorrect'
            <div class="mb-4 bg-red-100 dark:bg-red-900/25 border dark:border-slate-700 border-red-200 text-sm text-red-800 dark:text-red-200 rounded-lg p-4" role="alert">
              <span class="font-bold">Incorrect!</span>. Try harder.
            </div>
          %elif status == 'brute_force_attempt'
            <div class="mb-4 bg-red-100 dark:bg-red-900/25 border dark:border-slate-700 border-red-200 text-sm text-red-800 dark:text-red-200 rounded-lg p-4" role="alert">
              <span class="font-bold">Brute force attempt detected!</span> Wait {{ wait.seconds }} seconds and try again.
            </div>
          %elif status == 'correct'
            <div class="mb-4 bg-teal-100 dark:bg-teal-900/25 border dark:border-slate-700 border-teal-200 text-sm text-teal-800 dark:text-teal-200 rounded-lg p-4" role="alert">
              <span class="font-bold">Correct!</span> Congratulations.
            </div>
          %endif
          <div class="flex gap-4 items-center">
            <div class="grow">
              <input type="text" name="flag" class="border dark:border-slate-700 text-sm rounded-lg block w-full py-2 px-3 bg-gray-50 dark:bg-slate-900 border-gray-300 dark:border-slate-600 text-gray-900 dark:text-slate-100 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400" name="" value="" placeholder="Flag">
            </div>
            <button type="submit" name="action" value="flag" class="text-white dark:text-white bg-blue-700 hover:bg-blue-800 dark:hover:bg-blue-500 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-400 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
              Submit flag
            </button>
          </div>
        </div>
      </Form>
    %endif
  </div>
  <div class="max-w-3xl w-full mx-auto border dark:border-slate-700 shadow bg-white dark:bg-slate-800 mt-4 rounded">
    <table class="bg-white dark:bg-slate-800 w-full rounded">
      <thead>
        <tr class="h-12 text-left bg-slate-50 dark:bg-slate-800">
          <th class="rounded-tl pl-3" style="width:150px">Solved at</th>
          <th class="rounded-tr text-left" style="width:200px">User</th>
        </tr>
      </thead>
      <tbody>
        %for s in solved_users
          <tr class="h-12 border-t dark:border-slate-700 {{- ' bg-green-50 dark:bg-green-900/30' if s.status == 'CORRECT' }}">
            <td class="pl-3 text-gray-500 dark:text-slate-300 text-sm {{- ' rounded-bl' if loop.last }}">
              {{ (s.created_at + g.timezone_fix).strftime('%Y-%m-%d %H:%M') }}
            </td>
            <td>
              <a href="/user/{{ users[s.user_id].name }}" class="x-link">{{ users[s.user_id].name }}</a>
            </td>
          </tr>
        %else
          <tr class="border-t dark:border-slate-700">
            <td class="text-center h-12 text-gray-400 dark:text-slate-500 text-sm" colspan="2">
              No one solved yet.
            </td>
          </tr>
        %endfor
      </tbody>
    </table>
  </div>
%endblock

%block bottom
  <script>
    $('[data-page-content]').html(marked.parse({{ challenge.content|tojson }}))
  </script>
%endblock
